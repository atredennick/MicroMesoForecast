---
layout: 12pt
header-includes:
   - \usepackage{lineno}
   - \linenumbers
   - \usepackage{setspace}
   - \usepackage{graphicx}
   - \usepackage{morefloats}
bibliography: ~/Dropbox/Bibliography/MicroMeso.bib
csl: components/ecology.csl

## rmarkdown render options
output:
  pdf_document:
    fig_caption: true
    keep_tex: false
fontsize: 12pt
geometry: margin=1in
linkcolor: black
urlcolor: black
---

\renewcommand\thefigure{S\arabic{figure}}  
\renewcommand\thetable{S\arabic{table}}  

\begin{center}
\textbf{\Large{Supporting Information Appendix S1}}  \\
A.T. Tredennick, M.B. Hooten, \& P.B. Adler, ``Do we need demographic data...''  \\
\emph{Methods in Ecology and Evolution}
\end{center}

\tableofcontents
\listoffigures
\listoftables
\newpage{}

##  Hierarchical Bayesian models for vital rates
Here we describe the statistical models in complete detail, including full description of the Bayesian models and Stan code for each model. We write each model as three parts: (1) a data model (likelihood), (2) a process model, and (3) a parameter model. We then combine these three models to write the posterior and joint distributions as a single model statement. Following the full model expression we provide the Stan code that directly corresponds the statement of posterior and joint distributions. Note that Stan uses standard deviations ($\sigma$) to specify distributions rather than variances ($\sigma^2$). In our expressions of the posterior and joint distributions we use general probability notation where [.] represents some unspecified distribution. We do this for clarity of model presentation. All prior distributions are defined in the parameter model sections. For clarity, we avoid subscripting species.

### Parameter to model notation keys

Table:  Definition of parameters and model notation for IPM survival and growth models.

| Parameter | Definition | Notation in statistical results tables |
| --------- | ---------- | -------------------------------------- |
| $\beta_{0,t}$ | intercept for year *t* | ``a[t]`` where ``t`` is the numeric year |
| $\tilde{\beta_0}$ | global intercept | ``a_mu`` |
| $\beta_{Q,q}$ | random effect of quadrat group *q* | ``gint[q]`` where ``q`` is the quadrat group |
| $\beta_{s,t}$ | size effect for year *t* | ``b1[t]`` where ``t`` is the numeric year |
| $\tilde{\beta_s}$ | global size effect | ``b1_mu`` |
| $\beta_{d,1}$ | effect of crowding | ``w[1]`` |
| $\beta_{d,2}$ | crowding $\times$ size effect | ``w[2]`` |
| $\beta_{c,k}$ | effect of climate covariate *k* | ``b2[k]`` where ``k`` is the climate effect |
| *a* | first parameter for growth variance | ``tau`` |
| *b* | second parameter for growth variance | ``tauSize`` |

Table:  Definition of parameters and model notation for IPM recruitment model.

| Parameter | Definition | Notation in statistical results tables |
| --------- | ---------- | -------------------------------------- |
| $\beta_{0,t}$ | intercept for year *t* | ``a[t]`` where ``t`` is the numeric year |
| $\tilde{\beta_0}$ | global intercept | ``a_mu`` |
| $\beta_{Q,q}$ | random effect of quadrat group *q* | ``gint[q]`` where ``q`` is the quadrat group |
| $\beta_{d,1}$ | effect of plot cover | ``dd`` |
| $\beta_{c,k}$ | effect of climate covariate *k* | ``b2[k]`` where ``k`` is the climate effect |
| *p* | mixing fraction for effective plot cover | ``u`` |
| $\zeta$ | size parameter for negative binimial likelihood | ``theta`` |

Table:  Definition of parameters and model notation for quadrat based model.

| Parameter | Definition | Notation in statistical results tables |
| --------- | ---------- | -------------------------------------- |
| $\beta_{0,t}$ | intercept for year *t* | ``a[t]`` where ``t`` is the numeric year |
| $\tilde{\beta_0}$ | global intercept | ``a_mu`` |
| $\beta_{Q,q}$ | random effect of quadrat group *q* | ``gint[q]`` where ``q`` is the quadrat group |
| $\beta_{s,t}$ | cover effect for year *t* | ``b1[t]`` where ``t`` is the numeric year |
| $\tilde{\beta_s}$ | global cover effect | ``b1_mu`` |
| $\beta_{c,k}$ | effect of climate covariate *k* | ``b2[k]`` where ``k`` is the climate effect |
| $\tau$ | model variance in log normal likelihood | ``tau`` |

Table: Climate effect key.

| Integer ID (*k*) | Climate covariate |
| ---------------- | ----------------- |
| 1 | pptLag |
| 2 | ppt1 |
| 3 | ppt2 |
| 4 | TmeanSpr1 |
| 5 | TmeanSpr2 |
| 6 | ppt1 $\times$ TmeanSpr1 |
| 7 | ppt2 $\times$ TmeanSpr2 |

### Survival (IPM)
We used logistic regression to model the probability that genet *i* in quadrat *q* survives from time *t* to *t*+1 ($s_{i,q,t}$):

\begin{align}
y_{i,q,t}^{S} &\sim \text{Bernoulli}(s_{i,q,t}) \\
\text{logit}(s_{i,q,t}) &= \beta_{0,t} + \beta_{s,t}x_{i,q,t} + \beta_{Q,q} + \textbf{z}'_t \boldsymbol{\beta}_c + \beta_{d,1} w_{i,t} + \beta_{d,2} (x_{i,q,t}w_{i,q,t})
\end{align}

where $x_{i,q,t}$ is the log of genet *i* basal area at time *t*, $\beta_{0,t}$ is a year specific intercept, $\beta_{Q,q}$ is the random effect for the *q*th quadrat to account for spatial variation, $\beta_{s,t}$ is the year-specific slope parameter for size, **z** is a vector of *p* climate covariates specific to year *t*, $\boldsymbol{\beta}_c$ is a vector of fixed climate effects of length *p*, $\beta_{d,1}$ is the effect of intraspecific crowding experienced by the focal genet at time *t* ($w_{i,q,t}$), and $\beta_{d,2}$ is a size by crowding ($x_{i,q,t}w_{i,q,t}$) interaction effect.

**Data, process, and parameter models**

\begin{align}
& \mathtt{data} \qquad &y_{i,q,t}^{S} \sim \text{Bernoulli}(s_{i,q,t}) \\
& \mathtt{process} \qquad &\text{logit}(s_{i,q,t}) = \beta_{0,t} + \beta_{s,t}x_{i,q,t} + \beta_{Q,q} + \textbf{z}'_t \boldsymbol{\beta}_c + \beta_{d,1} w_{i,t} + \beta_{d,2} (x_{i,q,t}w_{i,q,t}) \\
& \mathtt{parameters} \qquad &\beta_{0,t} \sim \text{Normal}(\tilde{\beta_0}, \sigma_{\beta_0}^2)\\
& \qquad & \beta_{s,t} \sim \text{Normal}(\tilde{\beta_s}, \sigma_{\beta_s}^2) \\
& \qquad & \beta_{Q,q} \sim \text{Normal}(0, \sigma_Q^2) \\
& \qquad & \boldsymbol{\beta}_c \sim \text{Normal}(\textbf{0}, \sigma_c^2 \textbf{I}) \\
& \qquad & \beta_{d,1} \sim \text{Normal}(0, 100) \\
& \qquad & \beta_{d,2} \sim \text{Normal}(0, 100) \\
& \qquad & \tilde{\beta_0} \sim \text{Normal}(0, 100) \\
& \qquad & \tilde{\beta_s} \sim \text{Normal}(0, 100) \\
& \qquad & \sigma_Q \sim \text{Cauchy}(0, 5) \\
& \qquad & \sigma_{\beta_0} \sim \text{Cauchy}(0, 5) \\
& \qquad & \sigma_{\beta_s} \sim \text{Cauchy}(0, 5)
\end{align}

**Full expression of posterior and joint distributions**
\begin{align}
[\boldsymbol{\beta_0}, \tilde{\beta_0}, \boldsymbol{\beta_s}, \tilde{\beta_s}, \boldsymbol{\beta_Q,q}, \boldsymbol{\beta_c}, \beta_{d,1}, \beta_{d,2}, \sigma_Q^2, \sigma_{\beta_0}^2, \sigma_{\beta_s}^2 | y_{i,q,t}^{S}] &\propto \\
&\prod_{t=1}^T \prod_{i=1}^n [y_{i,q,t}^{S} | \beta_{0,t}, \beta_{s,t}, \beta_{Q}, \boldsymbol{\beta_c}, \beta_{d,1}, \beta_{d,2}] \times \\
&[\beta_{0,t} | \tilde{\beta_0}, \sigma_{\beta_0}^2] \times \\
&[\beta_{s,t} | \tilde{\beta_s}, \sigma_{\beta_s}^2] [\boldsymbol{\beta_c}|\sigma_{\beta_c}^2] \times \\
&\prod_{q=1}^{Q_{tot}} [\beta_{Q,q} | \sigma_Q^2] \times \\
&[\beta_{d,1}] [\beta_{d,1}] [\tilde{\beta_0}] [\tilde{\beta_s}] [\sigma_Q] [\sigma_{\beta_0}] [\sigma_{\beta_s}]
\end{align}

**Stan code for model**
```{r survival_stan, echo=TRUE, eval=FALSE}
data{
  // All Data
  int<lower=0> N; // observations
  int<lower=0> Yrs; // years
  int<lower=0> yid[N]; // year id
  int<lower=0> Covs; // climate covariates
  int<lower=0> G; // groups
  int<lower=0> gid[N]; // group id
  int<lower=0,upper=1> Y[N]; // observation vector
  matrix[N,Covs] C; // climate matrix
  vector[N] X; // size vector
  matrix[N,2] W; // crowding matrix
  real beta_tau; // prior sdev for climate effects
}
parameters{
  real a_mu;
  vector[Yrs] a;
  real b1_mu;
  vector[Yrs] b1;
  vector[Covs] b2;
  vector[2] w;
  vector[G] gint;
  real<lower=0> sig_a;
  real<lower=0> sig_b1;
  real<lower=0> sig_G;
}
transformed parameters{
  real mu[N];
  vector[N] climEff;
  vector[N] crowdEff;
  climEff <- C*b2;
  crowdEff <- W*w;
  for(n in 1:N){
    mu[n] <- inv_logit(a[yid[n]] + gint[gid[n]] + 
                         b1[yid[n]]*X[n] + crowdEff[n] + climEff[n]);
  }
}
model{
  // Priors
  a_mu ~ normal(0,10);
  w ~ normal(0,10);
  b1_mu ~ normal(0,10);
  sig_a ~ cauchy(0,5);
  sig_b1 ~ cauchy(0,5);
  sig_G ~ cauchy(0,5);
  gint ~ normal(0, sig_G);
  b2 ~ normal(0, beta_tau);
  a ~ normal(a_mu, sig_a);
  b1 ~ normal(b1_mu, sig_b1);
  
  // Likelihood
  Y ~ binomial(1,mu);
}
}
```


### Growth (IPM)
We modeled growth as a Gaussian process describing log genet size ($y_{i,q,t+1}^{G}$) at time $t+1$ in quadrat *q* as a function of log size at time $t$ and climate covariates:

\begin{align}
y_{i,q,t+1}^G &\sim \text{Normal}(\mu_{i,q,t+1}, \sigma^2_{x_{i,q,t+1}}) \\
\mu_{i,q,t+1} &= \beta_{0,t} + \beta_{s,t}x_{i,q,t} + \beta_{Q,q} + \textbf{z}'_t \boldsymbol{\beta}_c + \beta_{d,1} w_{i,q,t} + \beta_{d,2} (x_{i,q,t}w_{i,q,t})
\end{align}

where $\mu_{i,q,t+1}$ is log of genet *i*s predicted size at time *t* + 1, and all other parameters are as described for the survival regression. We capture non-constant error variance in growth by modeling the variance in the growth regression ($\sigma^2_{x{i,q,t+1}}$) as a nonlinear function of predicted genet size:

\begin{align}
\sigma^2_{x_{i,q,t+1}} = a \, \text{exp}[b \times \mu_{i,q,t+1}]
\end{align}

where $\mu_{i,q,t+1}$ is log of predicted genet size predicted from the growth regression (Eq. 4), and *a* and *b* are constants.

**Data, process, and parameter models.**
\begin{align}
&\mathtt{data} \qquad &y_{i,q,t+1}^G \sim \text{Normal}(\mu_{i,q,t+1}, \sigma^2_{x_{i,q,t+1}}) \\
&\mathtt{process} \qquad &\mu_{i,q,t+1} = \beta_{0,t} + \beta_{s,t}x_{i,q,t} + \beta_{Q,q} + \textbf{z}'_t \boldsymbol{\beta}_c + \beta_{d,1} w_{i,q,t} + \beta_{d,2} (x_{i,q,t}w_{i,q,t}) \\
& \qquad & \sigma^2_{iQ,t} = ae^{b\mu_{iQ,t+1}} \\
&\mathtt{parameters} \qquad &\beta_{0,t} \sim \text{Normal}(\tilde{\beta_0}, \sigma_{\beta_0}^2)\\
& \qquad & \beta_{s,t} \sim \text{Normal}(\tilde{\beta_s}, \sigma_{\beta_s}^2) \\
& \qquad & \beta_{Q,q} \sim \text{Normal}(0, \sigma_Q^2) \\
& \qquad & \boldsymbol{\beta}_c \sim \text{Normal}(\textbf{0}, \sigma_c^2 \textbf{I}) \\
& \qquad & \beta_{d,1} \sim \text{Normal}(0, 100) \\
& \qquad & \beta_{d,2} \sim \text{Normal}(0, 100) \\
& \qquad & \tilde{\beta_0} \sim \text{Normal}(0, 100) \\
& \qquad & \tilde{\beta_s} \sim \text{Normal}(0, 100) \\
& \qquad & \sigma_Q \sim \text{Cauchy}(0, 5) \\
& \qquad & \sigma_{\beta_0} \sim \text{Cauchy}(0, 5) \\
& \qquad & \sigma_{\beta_s} \sim \text{Cauchy}(0, 5) \\
& \qquad & a \sim \text{Normal}(0, 100) \\
& \qquad & b \sim \text{Normal}(0, 100)
\end{align}

**Full expression of posterior and joint distributions**
\begin{align}
[\boldsymbol{\beta_0}, \tilde{\beta_0}, \boldsymbol{\beta_s}, \tilde{\beta_s}, \beta_{Q,q}, \boldsymbol{\beta_c}, \beta_{d,1}, \beta_{d,2}, \sigma_Q^2, \sigma_{\beta_0}^2, \sigma_{\beta_s}^2,a,b | y_{i,q,t+1}^G] &\propto \\
&\prod_{t=1}^T \prod_{i=1}^n [y_{i,q,t+1}^G | \beta_{0,t}, \beta_{s,t}, \beta_{Q}, \boldsymbol{\beta_c}, \beta_{d,1}, \beta_{d,2}, a, b] \times \\
&[\beta_{0,t} | \tilde{\beta_0}, \sigma_{\beta_0}^2] \times \\
&[\beta_{s,t} | \tilde{\beta_s}, \sigma_{\beta_s}^2] [\boldsymbol{\beta_c}|\sigma_{\beta_c}^2] \times \\
&\prod_{q=1}^{Q_{tot}} [\beta_{Q,q} | \sigma_Q^2] \times \\
&[\beta_{d,1}] [\beta_{d,1}] [\tilde{\beta_0}] [\tilde{\beta_s}] [\sigma_Q] [\sigma_{\beta_0}] [\sigma_{\beta_s}] [a] [b]
\end{align}

**Stan code for model**
```{r grow_stan, echo=FALSE, eval=FALSE}
data{
  int<lower=0> N; // observations
  int<lower=0> Yrs; // years
  int<lower=0> yid[N]; // year id
  int<lower=0> Covs; // climate covariates
  real<lower=0> tau_beta; // prior sdev for climate effects
  int<lower=0> G; // groups
  int<lower=0> gid[N]; // group id
  vector[N] Y; // observation vector
  matrix[N,Covs] C; // climate matrix
  vector[N] X; // size vector
  matrix[N,2] W; // crowding matrix
}
parameters{
  real a_mu;
  vector[Yrs] a;
  real b1_mu;
  vector[Yrs] b1;
  vector[Covs] b2;
  vector[2] w;
  real gint[G];
  real tau;
  real tauSize;
  real<lower=0> sig_a;
  real<lower=0> sig_b1;
  real<lower=0> sig_G;
}
transformed parameters{
  vector[N] mu;
  real<lower=0> sigma[N];
  vector[N] climEff;
  vector[N] crowdEff;
  climEff <- C*b2;
  crowdEff <- W*w;
  for(n in 1:N){
    mu[n] <- a[yid[n]] + gint[gid[n]] + b1[yid[n]]*X[n] + crowdEff[n] + climEff[n];
    sigma[n] <- sqrt((fmax(tau*exp(tauSize*mu[n]), 0.0000001)));  
  }
}
model{
  // Priors
  a_mu ~ normal(0,100);
  w ~ normal(0,10);
  b1_mu ~ normal(0,100);
  tau ~ normal(0,100);
  tauSize ~ normal(0,100);
  sig_a ~ cauchy(0,2);
  sig_b1 ~ cauchy(0,2);
  sig_G ~ cauchy(0,2);
  b2 ~ normal(0, tau_beta);
  for(g in 1:G)
    gint[g] ~ normal(0, sig_G);
  for(y in 1:Yrs){
    a[y] ~ normal(a_mu, sig_a);
    b1[y] ~ normal(b1_mu, sig_b1);
  }

  // Likelihood
  Y ~ normal(mu, sigma);
}
```


### Recruitment (IPM)
Our data allows us to track new recruits, but we cannot assign a specific parent to new genets. 
Therefore, we model recruitment at the quadrat level.
We assume the number of individuals, $y^{R}_{q,t+1}$, recruiting at time $t+1$ in quadrat *q* follows a negative binomial distribution:

\begin{align}
y^{R}_{q,t+1} \sim \text{NegBin}(\lambda_{q,t+1},\phi)
\end{align}

where $\lambda$ is the mean intensity and $\phi$ is the size parameter. We define $\lambda$ as a function of quadrat composition and climate in the previous year:

\begin{align}
\lambda_{q,t+1} = \tilde{c}_{q,t} \, \text{exp}\left(\beta_{0,t} + \beta_{Q,q} + \textbf{z}'_t \boldsymbol{\beta}_c + \beta_{d}\sqrt{\tilde{c}_{q,t}}\right)
\end{align}

where $\tilde{c}_{q,t}$ is effective cover ($\text{cm}^2$) of the focal species in quadrat *q* at time *t*, and all other terms are as in the survival and growth regressions.
Effective cover is a mixture of observed cover (*c*) in the focal quadrat (*q*) and the mean cover across the entire group ($\bar{c}$) of *Q* quadrats in which *q* is located:

\begin{align}
\tilde{c}_{q,t} = pc_{q,t} + (1-p)\bar{c}_{Q,t}
\end{align}

where $p$ is a mixing fraction between 0 and 1 that is estimated when fitting model.

**Data, process, and parameter models**
\begin{align}
&\mathtt{data} \qquad &y^{R}_{q,t+1} \sim \text{NegBin}(\lambda_{q,t+1},\phi) \\
&\mathtt{process} \qquad &\lambda_{q,t+1} = \tilde{c}_{q,t} \, \text{exp}\left(\beta_{0,t} + \beta_{Q,q} + \textbf{z}'_t \boldsymbol{\beta}_c + \beta_{d}\sqrt{\tilde{c}_{q,t}}\right) \\
&\mathtt{parameters} \qquad &\beta_{0,t} \sim \text{Normal}(\tilde{\beta_0}, \sigma_{\beta_0}^2)\\
& \qquad & \beta_{Q,q} \sim \text{Normal}(0,\sigma_Q^2) \\
& \qquad & \boldsymbol{\beta}_c \sim \text{Normal}(\textbf{0}, \sigma_c^2 \textbf{I}) \\
& \qquad & \beta_{d} \sim \text{Uniform}(-10, 10) \\
& \qquad & \tilde{\beta_0} \sim \text{Normal}(0, 100) \\
& \qquad & \sigma_Q \sim \text{Cauchy}(0, 5) \\
& \qquad & \sigma_{\beta_0} \sim \text{Cauchy}(0, 5) \\
& \qquad & \phi \sim \text{Uniform}(0, 10) \\
& \qquad & u \sim \text{Uniform}(0, 1)
\end{align}

**Full expression of posterior and joint distributions**
\begin{align}
[\boldsymbol{\beta_0}, \tilde{\beta}, \boldsymbol{\beta_Q}, \boldsymbol{\beta_c}, \beta_{d}, \sigma_Q^2, \sigma_{\beta_0}^2, \phi, u | y^{R}_{q,t+1}] &\propto \\
&\prod_{t=1}^T \prod_{i=1}^n [y^{R}_{q,t+1} | \beta_{0,t}, \beta_{Q,q}, \beta_d, \boldsymbol{\beta_c}, \phi, u] \times \\
&[\beta_{0,t} | \tilde{\beta}, \sigma_{\beta_0}^2] [\boldsymbol{\beta_c}|\sigma_{\beta_c}^2] \times \\
&\prod_{q=1}^{Q_{tot}} [\beta_{Q,q} | \sigma_Q^2] [\boldsymbol{\beta_c}] [\beta_d] [\tilde{\beta_0}] [\sigma_Q] [\sigma_{\beta_0}] [\phi] [u]
\end{align}

**Stan code for model**
```{r rec_stan, echo=TRUE, eval=FALSE}
data{
  int<lower=0> N; // observations
  int<lower=0> Yrs; // years
  int<lower=0> yid[N]; // year id
  int<lower=0> Covs; // climate covariates
  int<lower=0> G; // groups
  int<lower=0> gid[N]; // group id
  int<lower=0> Y[N]; // observation vector
  matrix[N,Covs] C; // climate matrix
  vector[N] parents1; // crowding vector
  vector[N] parents2; // crowding vector
  real<lower=0> tau; // prior variance
}
parameters{
  real a_mu;
  vector[Yrs] a;
  vector[Covs] b2;
  real dd;
  real gint[G];
  real<lower=0> sig_a;
  real<lower=0> theta;
  real<lower=0> sig_G;
  real<lower=0, upper=1> u;
}
transformed parameters{
real mu[N];
vector[N] climEff;
vector[N] trueP1;
vector[N] trueP2;
vector[N] lambda;
climEff <- C*b2;
  for(n in 1:N){
    trueP1[n] <- parents1[n]*u + parents2[n]*(1-u);
    trueP2[n] <- sqrt(trueP1[n]);
    mu[n] <- exp(a[yid[n]] + gint[gid[n]] + dd*trueP2[n] + climEff[n]);
    lambda[n] <- trueP1[n]*mu[n];
  }
}
model{
// Priors
  u ~ uniform(0,1);
  theta ~ uniform(0,10);
  a_mu ~ normal(0,10);
  dd ~ uniform(-10,10);
  sig_a ~ cauchy(0,5);
  sig_G ~ cauchy(0,5);
  for(g in 1:G)
   gint[g] ~ normal(0, sig_G);
  for(y in 1:Yrs){
    a[y] ~ normal(a_mu, sig_a);
  }
  for(j in 1:Covs)
    b2[j] ~ normal(0, tau);

// Likelihood
  Y ~ neg_binomial_2(lambda, theta);
}

```


### Quadrat based model (QBM)
The model for quadrat cover change from time $t$ to $t+1$ is

\begin{align}
y_{q,t+1}^{P} &\sim \text{LogNormal}(\mu_{q,t+1}, \sigma^2)_{0}^{1} \\
\mu_{q,t+1} &= \beta_{0,t} + \beta_{s,t}x_{q,t} + \beta_{Q,q} + \textbf{z}'_t \boldsymbol{\beta}_c
\end{align}

where $\mu_{q,t+1}$ is the log of proportional cover in quadrat *q* at time $t+1$, and all other parameters are as in the individual-level growth model (Eq. 4) except that *x* now represents log of proportional cover. The log normal likelihood includes a truncation (subscript 0, superscript 1) to ensure that predicted values do not exceed 100% cover. 

**Data, process, and parameter models.**
\begin{align}
&\mathtt{data} \qquad &y_{q,t+1}^{P} \sim \text{LogNormal}(\mu_{q,t+1}, \sigma^2)_{0}^{1} \\
&\mathtt{process} \qquad &\mu_{q,t+1} = \beta_{0,t} + \beta_{s,t}x_{q,t} + \beta_{Q,q} + \textbf{z}'_t \boldsymbol{\beta}_c \\
&\mathtt{parameters} \qquad &\beta_{0,t} \sim \text{Normal}(\tilde{\beta_0}, \sigma_{\beta_0}^2)\\
& \qquad & \beta_{s,t} \sim \text{Normal}(\tilde{\beta_s}, \sigma_{\beta_s}^2) \\
& \qquad & \beta_{Q,q} \sim \text{Normal}(0,\sigma_Q^2) \\
& \qquad & \boldsymbol{\beta}_c \sim \text{Normal}(\textbf{0}, \sigma_c^2 \textbf{I}) \\
& \qquad & \tilde{\beta_0} \sim \text{Normal}(0, 100) \\
& \qquad & \tilde{\beta_s} \sim \text{Normal}(0, 100) \\
& \qquad & \sigma_Q \sim \text{Cauchy}(0, 5) \\
& \qquad & \sigma_{\beta_0} \sim \text{Cauchy}(0, 5) \\
& \qquad & \sigma_{\beta_s} \sim \text{Cauchy}(0, 5) \\
& \qquad & \sigma^2 \sim \text{Inverse Gamma}(0.001, 0.001)
\end{align}

**Full expression of posterior and joint distributions**
\begin{align}
[\boldsymbol{\beta_0}, \tilde{\beta_0}, \boldsymbol{\beta_s}, \tilde{\beta_s}, \boldsymbol{\beta_Q}, \boldsymbol{\beta_c}, \sigma_Q^2, \sigma_{\beta_0}^2, \sigma_{\beta_s}^2, \sigma^2 | y_{q,t+1}^{P}] &\propto \\
&\prod_{t=1}^T \prod_{i=1}^n [y_{q,t+1} | \beta_{0,t}, \beta_{s,t}, \beta_{Q,q}, \boldsymbol{\beta_c}] \times \\
&[\beta_{0,t} | \tilde{\beta_0}, \sigma_{\beta_0}^2] \times \\
&[\beta_{s,t} | \tilde{\beta_s}, \sigma_{\beta_s}^2] [\boldsymbol{\beta_c}|\sigma_{\beta_c}^2] \times \\
&\prod_{q=1}^{Q_{tot}} [\beta_{Q,q} | \sigma_Q^2] \times \\
&[\tilde{\beta_0}] [\tilde{\beta_s}] [\sigma_Q] [\sigma_{\beta_0}] [\sigma_{\beta_s}] [\sigma]
\end{align}

**Stan code for model**
```{r qbm_stan, echo=TRUE, eval=FALSE}
data{
  int<lower=0> N; // observations
  int<lower=0> Yrs; // years
  int<lower=0> yid[N]; // year id
  int<lower=0> Covs; // climate covariates
  int<lower=0> G; // groups
  int<lower=0> gid[N]; // group id
  real<lower=0,upper=1> Y[N]; // observation vector
  real<lower=0> sd_clim; // prior sd on climate effects
  matrix[N,Covs] C; // climate matrix
  vector[N] X; // size vector
}
parameters{
  real a_mu;
  vector[Yrs] a;
  real b1_mu;
  vector[Yrs] b1;
  vector[Covs] b2;
  vector[G] gint;
  real<lower=0> sig_a;
  real<lower=0> sig_b1;
  real<lower=0> sig_G;
  real<lower=0> sigmaSq;
}
transformed parameters{
  real mu[N];
  vector[N] climEff;
  real<lower=0> tau;
  tau <- sqrt(sigmaSq);
  climEff <- C*b2;
  for(n in 1:N)
    mu[n] <- a[yid[n]] + gint[gid[n]] + b1[yid[n]]*X[n] + climEff[n];
}
model{
  // Priors
  a_mu ~ normal(0,10);
  b1_mu ~ normal(0,10);
  sig_a ~ cauchy(0,5);
  sig_b1 ~ cauchy(0,5);
  sig_G ~ cauchy(0,5);
  gint ~ normal(0, sig_G);
  b2 ~ normal(0,sd_clim);
  a ~ normal(a_mu, sig_a);
  b1 ~ normal(b1_mu, sig_b1);
  sigmaSq ~ inv_gamma(1, 1);
  
  //Likelihood
  Y ~ lognormal(mu, tau);
}
}
```

\newpage{}

##  Supporting Figures
\begin{figure}[!ht]
  \centering
      \includegraphics[height=6in]{./components/forecast_error_mockup.png}
  \caption{Comparison of one-step-ahead, out-of-sample forecast error (mean absolute error) between the IPM and QBM models with and without the inclusion of climate covariates.}
\end{figure}


\newpage{}

\begin{figure}[!ht]
  \centering
      \includegraphics[height=4in]{./components/lppds_suppfig.png}
  \caption{Results from ridge regression: summed log pointwise predictive densities (\emph{lppd}) as a function of the prior variance of climate covariates. Dashed, red vertical lines show the highest prior variance with the highest \emph{lppd} indicating the value of prior variance for optimal prediction.}
\end{figure}

\newpage{}

\begin{figure}[!ht]
  \centering
      \includegraphics[height=6in]{./components/forecast_accuracy_means_mockup.png}
  \caption{Comparison of one-step-ahead, out-of-sample forecast accuracy (mean correlation between observations and predictions) between the IPM and QBM models with and without the inclusion of climate covariates.}
\end{figure}

\newpage{}

## Supporting Tables
```{r lib_reqs, echo=FALSE, message=FALSE, warning=FALSE}
library(xtable)
library(plyr)
library(reshape2)
library(ggmcmc)
```

```{r agg_fxn, echo=FALSE, message=FALSE, warning=FALSE}
agg_fxn <- function(mcmc_frame){
  out <- ddply(mcmc_frame, .(Parameter), summarise,
               mean_value = mean(value),
               sd_value = sd(value),
               lo_BCI = quantile(value, 0.025),
               up_BCI = quantile(value, 0.975))
  return(out)
}
spp_list <- c("BOGR", "HECO", "PASM", "POSE")
spp_name <- c("B. gracilis.", "H. comata.", "P. smithii.", "P. secunda.")
```

In all tables, "mean_value" is the mean parameter estimate, "sd_value" is the standard deviation of the estimate from the MCMC, "lo_BCI" is the lower limit of the 95% Bayesian Credible Interval, and "up_BCI" is the upper limit of the 95% Bayesian Credible Interval. See Tables S1-S4 for definitions and notations for model parameters.

```{r surv_params, echo=FALSE, results='asis', message=FALSE, warning=FALSE, comment=NA}
for(i in 1:length(spp_list)){
  file <- paste("../analysis/ipm/vitalRateRegs/survival/survival_stanmcmc_",
              spp_list[i], ".RDS",
              sep="")
  survmcmc <- ggs(readRDS(file))
  aggsurv <- agg_fxn(survmcmc)
  cap <- paste("Statistical results from IPM survival model for\\emph{", spp_name[i],"}")
  print(xtable(aggsurv, caption = cap), comment=FALSE, include.rownames=FALSE, 
        size="\\footnotesize", caption.placement = "top")
}
```

```{r growth_params, echo=FALSE, results='asis', message=FALSE, warning=FALSE, comment=NA}
for(i in 1:length(spp_list)){
  file <- paste("../analysis/ipm/vitalRateRegs/growth/growth_stanmcmc_",
              spp_list[i], ".RDS",
              sep="")
  survmcmc <- readRDS(file)
  aggsurv <- agg_fxn(survmcmc)
  cap <- paste("Statistical results from IPM growth model for\\emph{", spp_name[i],"}")
  print(xtable(aggsurv, caption = cap), comment=FALSE, include.rownames=FALSE, 
        size="\\footnotesize", caption.placement = "top")
}
```

```{r rec_params, echo=FALSE, results='asis', message=FALSE, warning=FALSE, comment=NA}
for(i in 1:length(spp_list)){
  file <- paste("../analysis/ipm/vitalRateRegs/recruitment/recruitment_stanmcmc_",
              spp_list[i], ".RDS",
              sep="")
  survmcmc <- ggs(readRDS(file))
  aggsurv <- agg_fxn(survmcmc)
  cap <- paste("Statistical results from IPM recruitment model for\\emph{", spp_name[i],"}")
  print(xtable(aggsurv, caption = cap), comment=FALSE, include.rownames=FALSE, 
        size="\\footnotesize", caption.placement = "top")
}
```

```{r qbm_params, echo=FALSE, results='asis', message=FALSE, warning=FALSE, comment=NA}
for(i in 1:length(spp_list)){
  file <- paste("../analysis/quadBM/vitalRateRegressions/truncNormModel/popgrowth_stanmcmc_",
              spp_list[i], ".RDS",
              sep="")
  survmcmc <- readRDS(file)
  aggsurv <- agg_fxn(survmcmc)
  cap <- paste("Statistical results from QBM population model for\\emph{", spp_name[i],"}")
  print(xtable(aggsurv, caption = cap), comment=FALSE, include.rownames=FALSE, 
        size="\\footnotesize", caption.placement = "top")
}
```

\newpage{}

\begin{table}[ht]
\centering
\caption {Statistical tests to assess whether models without climate covariates have higher accuracy and lower error than models with climate covariates. t-tests are one-sided.}
\begin{footnotesize}
\begin{tabular}{lllrrrl}
  \hline
comparison & performance\_measure & test\_type & test\_statistic & df & p\_value & species \\ 
  \hline
simple IPM vs. climate IPM & rho & t & -1.196 & 279.000 & 0.884 & BOGR \\ 
  simple IPM vs. climate IPM & MAE & t & -2.333 & 280.000 & 0.990 & BOGR \\ 
  simple QBM vs. climate QBM & rho & t & -1.798 & 279.000 & 0.963 & BOGR \\ 
  simple QBM vs. climate QBM & MAE & t & -3.340 & 280.000 & 1.000 & BOGR \\ 
  simple IPM vs. climate IPM & rho & t & -0.037 & 169.000 & 0.515 & HECO \\ 
  simple IPM vs. climate IPM & MAE & t & -2.130 & 170.000 & 0.983 & HECO \\ 
  simple QBM vs. climate QBM & rho & t & 0.747 & 169.000 & 0.228 & HECO \\ 
  simple QBM vs. climate QBM & MAE & t & 1.145 & 170.000 & 0.127 & HECO \\ 
  simple IPM vs. climate IPM & rho & t & 0.097 & 215.000 & 0.462 & PASM \\ 
  simple IPM vs. climate IPM & MAE & t & -0.556 & 216.000 & 0.711 & PASM \\ 
  simple QBM vs. climate QBM & rho & t & 0.631 & 215.000 & 0.264 & PASM \\ 
  simple QBM vs. climate QBM & MAE & t & 4.276 & 216.000 & 0.000 & PASM \\ 
  simple IPM vs. climate IPM & rho & t & -1.479 & 195.000 & 0.930 & POSE \\ 
  simple IPM vs. climate IPM & MAE & t & -2.185 & 196.000 & 0.985 & POSE \\ 
  simple QBM vs. climate QBM & rho & t & -1.564 & 195.000 & 0.940 & POSE \\ 
  simple QBM vs. climate QBM & MAE & t & -2.468 & 196.000 & 0.993 & POSE \\
   \hline
\end{tabular}
\end{footnotesize}
\end{table}

\newpage{}

\begin{table}[ht]
\centering
\caption {Statistical tests of model comparisons. Table shows results from one-sided t-tests for the particular comparison.}
\begin{footnotesize}
\begin{tabular}{lllrrrl}
  \hline
comparison & performance\_measure & test\_type & test\_statistic & df & p\_value & species \\ 
  \hline
limate IPM vs. simple IPM & rho & t & 1.196 & 279.000 & 0.116 & BOGR \\ 
  climate IPM vs. simple IPM & MAE & t & -2.333 & 280.000 & 0.010 & BOGR \\ 
  climate QBM vs. simple QBM & rho & t & 1.798 & 279.000 & 0.037 & BOGR \\ 
  climate QBM vs. simple QBM & MAE & t & -3.340 & 280.000 & 0.000 & BOGR \\ 
  simple IPM vs. simple QBM & rho & t & -1.757 & 279.000 & 0.960 & BOGR \\ 
  simple IPM vs. simple QBM & MAE & t & 2.338 & 280.000 & 0.990 & BOGR \\ 
  climate IPM vs. climate QBM & rho & t & -1.083 & 279.000 & 0.860 & BOGR \\ 
  climate IPM vs. climate QBM & MAE & t & 1.151 & 280.000 & 0.875 & BOGR \\ 
  climate IPM vs. simple IPM & rho & t & 0.037 & 169.000 & 0.485 & HECO \\ 
  climate IPM vs. simple IPM & MAE & t & -2.130 & 170.000 & 0.017 & HECO \\ 
  climate QBM vs. simple QBM & rho & t & -0.747 & 169.000 & 0.772 & HECO \\ 
  climate QBM vs. simple QBM & MAE & t & 1.145 & 170.000 & 0.873 & HECO \\ 
  simple IPM vs. simple QBM & rho & t & -1.638 & 169.000 & 0.948 & HECO \\ 
  simple IPM vs. simple QBM & MAE & t & 4.011 & 170.000 & 1.000 & HECO \\ 
  climate IPM vs. climate QBM & rho & t & -0.704 & 169.000 & 0.759 & HECO \\ 
  climate IPM vs. climate QBM & MAE & t & 0.329 & 170.000 & 0.629 & HECO \\ 
  climate IPM vs. simple IPM & rho & t & -0.097 & 215.000 & 0.538 & PASM \\ 
  climate IPM vs. simple IPM & MAE & t & -0.556 & 216.000 & 0.289 & PASM \\ 
  climate QBM vs. simple QBM & rho & t & -0.631 & 215.000 & 0.736 & PASM \\ 
  climate QBM vs. simple QBM & MAE & t & 4.276 & 216.000 & 1.000 & PASM \\ 
  simple IPM vs. simple QBM & rho & t & 0.552 & 215.000 & 0.291 & PASM \\ 
  simple IPM vs. simple QBM & MAE & t & -1.033 & 216.000 & 0.151 & PASM \\ 
  climate IPM vs. climate QBM & rho & t & 2.022 & 215.000 & 0.022 & PASM \\ 
  climate IPM vs. climate QBM & MAE & t & -5.309 & 216.000 & 0.000 & PASM \\ 
  climate IPM vs. simple IPM & rho & t & 1.479 & 195.000 & 0.070 & POSE \\ 
  climate IPM vs. simple IPM & MAE & t & -2.185 & 196.000 & 0.015 & POSE \\ 
  climate QBM vs. simple QBM & rho & t & 1.564 & 195.000 & 0.060 & POSE \\ 
  climate QBM vs. simple QBM & MAE & t & -2.468 & 196.000 & 0.007 & POSE \\ 
  simple IPM vs. simple QBM & rho & t & 0.297 & 195.000 & 0.383 & POSE \\ 
  simple IPM vs. simple QBM & MAE & t & 1.027 & 196.000 & 0.847 & POSE \\ 
  climate IPM vs. climate QBM & rho & t & 1.137 & 195.000 & 0.128 & POSE \\ 
  climate IPM vs. climate QBM & MAE & t & 0.455 & 196.000 & 0.675 & POSE \\ 
   \hline
\end{tabular}
\end{footnotesize}
\end{table}

\newpage{}

\begin{table}[ht]
\centering
\caption {Statistical tests of model comparisons at different forecast horizons. Table shows results from one-sided t-tests for the particular comparison.}
\begin{scriptsize}
\begin{tabular}{lllrrrlr}
  \hline
comparison & performance\_measure & test\_type & test\_statistic & df & p\_value & species & horizon \\ 
  \hline
climate IPM vs. climate QBM & rho & t & -0.122 & 167.000 & 0.549 & PASM & 1.000 \\ 
  climate IPM vs. climate QBM & rho & t & 0.394 & 149.000 & 0.347 & POSE & 1.000 \\ 
  climate IPM vs. climate QBM & rho & t & -0.436 & 129.000 & 0.668 & HECO & 1.000 \\ 
  climate IPM vs. climate QBM & rho & t & -0.318 & 129.000 & 0.625 & BOGR & 1.000 \\ 
  climate IPM vs. climate QBM & rho & t & -1.015 & 150.000 & 0.844 & PASM & 2.000 \\ 
  climate IPM vs. climate QBM & rho & t & -0.876 & 132.000 & 0.809 & POSE & 2.000 \\ 
  climate IPM vs. climate QBM & rho & t & -0.790 & 115.000 & 0.784 & HECO & 2.000 \\ 
  climate IPM vs. climate QBM & rho & t & -0.049 & 114.000 & 0.519 & BOGR & 2.000 \\ 
  climate IPM vs. climate QBM & rho & t & 0.610 & 129.000 & 0.272 & PASM & 3.000 \\ 
  climate IPM vs. climate QBM & rho & t & -0.719 & 112.000 & 0.763 & POSE & 3.000 \\ 
  climate IPM vs. climate QBM & rho & t & -1.871 & 98.000 & 0.968 & HECO & 3.000 \\ 
  climate IPM vs. climate QBM & rho & t & -0.006 & 96.000 & 0.503 & BOGR & 3.000 \\ 
  climate IPM vs. climate QBM & rho & t & 0.761 & 108.000 & 0.224 & PASM & 4.000 \\ 
  climate IPM vs. climate QBM & rho & t & -0.168 & 94.000 & 0.566 & POSE & 4.000 \\ 
  climate IPM vs. climate QBM & rho & t & -0.600 & 82.000 & 0.725 & HECO & 4.000 \\ 
  climate IPM vs. climate QBM & rho & t & 0.196 & 78.000 & 0.423 & BOGR & 4.000 \\ 
  climate IPM vs. climate QBM & rho & t & 0.226 & 91.000 & 0.411 & PASM & 5.000 \\ 
  climate IPM vs. climate QBM & rho & t & -0.043 & 79.000 & 0.517 & POSE & 5.000 \\ 
  climate IPM vs. climate QBM & rho & t & -0.794 & 70.000 & 0.785 & HECO & 5.000 \\ 
  climate IPM vs. climate QBM & rho & t & 0.180 & 65.000 & 0.429 & BOGR & 5.000 \\ 
  climate IPM vs. climate QBM & rho & t & -0.331 & 75.000 & 0.629 & PASM & 6.000 \\ 
  climate IPM vs. climate QBM & rho & t & 0.743 & 66.000 & 0.230 & POSE & 6.000 \\ 
  climate IPM vs. climate QBM & rho & t & -0.658 & 59.000 & 0.743 & HECO & 6.000 \\ 
  climate IPM vs. climate QBM & rho & t & -0.015 & 54.000 & 0.506 & BOGR & 6.000 \\ 
  climate IPM vs. climate QBM & rho & t & 0.805 & 62.000 & 0.212 & PASM & 7.000 \\ 
  climate IPM vs. climate QBM & rho & t & -0.222 & 53.000 & 0.587 & POSE & 7.000 \\ 
  climate IPM vs. climate QBM & rho & t & -1.009 & 50.000 & 0.841 & HECO & 7.000 \\ 
  climate IPM vs. climate QBM & rho & t & -0.095 & 44.000 & 0.537 & BOGR & 7.000 \\ 
  climate IPM vs. climate QBM & rho & t & -0.001 & 54.000 & 0.500 & PASM & 8.000 \\ 
  climate IPM vs. climate QBM & rho & t & -0.155 & 47.000 & 0.561 & POSE & 8.000 \\ 
  climate IPM vs. climate QBM & rho & t & -0.460 & 43.000 & 0.676 & HECO & 8.000 \\ 
  climate IPM vs. climate QBM & rho & t & -1.671 & 37.000 & 0.948 & BOGR & 8.000 \\  
   \hline
\end{tabular}
\end{scriptsize}
\end{table}

\newpage{}


\begin{table}[ht]
\centering
\caption {Statistical tests of model comparisons at different forecast horizons. Table shows results from one-sided t-tests for the particular comparison. Note the reverse order of comparisons relative to Table S23.}
\begin{scriptsize}
\begin{tabular}{lllrrrlr}
  \hline
comparison & performance\_measure & test\_type & test\_statistic & df & p\_value & species & horizon \\ 
  \hline
climate QBM vs. climate IPM & rho & t & 0.122 & 167.000 & 0.451 & PASM & 1.000 \\ 
  climate QBM vs. climate IPM & rho & t & -0.394 & 149.000 & 0.653 & POSE & 1.000 \\ 
  climate QBM vs. climate IPM & rho & t & 0.436 & 129.000 & 0.332 & HECO & 1.000 \\ 
  climate QBM vs. climate IPM & rho & t & 0.318 & 129.000 & 0.375 & BOGR & 1.000 \\ 
  climate QBM vs. climate IPM & rho & t & 1.015 & 150.000 & 0.156 & PASM & 2.000 \\ 
  climate QBM vs. climate IPM & rho & t & 0.876 & 132.000 & 0.191 & POSE & 2.000 \\ 
  climate QBM vs. climate IPM & rho & t & 0.790 & 115.000 & 0.216 & HECO & 2.000 \\ 
  climate QBM vs. climate IPM & rho & t & 0.049 & 114.000 & 0.481 & BOGR & 2.000 \\ 
  climate QBM vs. climate IPM & rho & t & -0.610 & 129.000 & 0.728 & PASM & 3.000 \\ 
  climate QBM vs. climate IPM & rho & t & 0.719 & 112.000 & 0.237 & POSE & 3.000 \\ 
  climate QBM vs. climate IPM & rho & t & 1.871 & 98.000 & 0.032 & HECO & 3.000 \\ 
  climate QBM vs. climate IPM & rho & t & 0.006 & 96.000 & 0.497 & BOGR & 3.000 \\ 
  climate QBM vs. climate IPM & rho & t & -0.761 & 108.000 & 0.776 & PASM & 4.000 \\ 
  climate QBM vs. climate IPM & rho & t & 0.168 & 94.000 & 0.434 & POSE & 4.000 \\ 
  climate QBM vs. climate IPM & rho & t & 0.600 & 82.000 & 0.275 & HECO & 4.000 \\ 
  climate QBM vs. climate IPM & rho & t & -0.196 & 78.000 & 0.577 & BOGR & 4.000 \\ 
  climate QBM vs. climate IPM & rho & t & -0.226 & 91.000 & 0.589 & PASM & 5.000 \\ 
  climate QBM vs. climate IPM & rho & t & 0.043 & 79.000 & 0.483 & POSE & 5.000 \\ 
  climate QBM vs. climate IPM & rho & t & 0.794 & 70.000 & 0.215 & HECO & 5.000 \\ 
  climate QBM vs. climate IPM & rho & t & -0.180 & 65.000 & 0.571 & BOGR & 5.000 \\ 
  climate QBM vs. climate IPM & rho & t & 0.331 & 75.000 & 0.371 & PASM & 6.000 \\ 
  climate QBM vs. climate IPM & rho & t & -0.743 & 66.000 & 0.770 & POSE & 6.000 \\ 
  climate QBM vs. climate IPM & rho & t & 0.658 & 59.000 & 0.257 & HECO & 6.000 \\ 
  climate QBM vs. climate IPM & rho & t & 0.015 & 54.000 & 0.494 & BOGR & 6.000 \\ 
  climate QBM vs. climate IPM & rho & t & -0.805 & 62.000 & 0.788 & PASM & 7.000 \\ 
  climate QBM vs. climate IPM & rho & t & 0.222 & 53.000 & 0.413 & POSE & 7.000 \\ 
  climate QBM vs. climate IPM & rho & t & 1.009 & 50.000 & 0.159 & HECO & 7.000 \\ 
  climate QBM vs. climate IPM & rho & t & 0.095 & 44.000 & 0.463 & BOGR & 7.000 \\ 
  climate QBM vs. climate IPM & rho & t & 0.001 & 54.000 & 0.500 & PASM & 8.000 \\ 
  climate QBM vs. climate IPM & rho & t & 0.155 & 47.000 & 0.439 & POSE & 8.000 \\ 
  climate QBM vs. climate IPM & rho & t & 0.460 & 43.000 & 0.324 & HECO & 8.000 \\ 
  climate QBM vs. climate IPM & rho & t & 1.671 & 37.000 & 0.052 & BOGR & 8.000 \\ 
   \hline
\end{tabular}
\end{scriptsize}
\end{table}

